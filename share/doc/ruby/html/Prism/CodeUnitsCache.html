<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>class Prism::CodeUnitsCache - Documentation for Ruby 3.4</title>

  <meta name="keywords" content="ruby,class,Prism::CodeUnitsCache">

    <meta name="description" content="class Prism::CodeUnitsCache: A cache that can be used to quickly compute code unit offsets from byte offsets. It purposefully provides only a single #[] method to access the cache">

<script type="text/javascript">
  var rdoc_rel_prefix = "../";
  var index_rel_prefix = "../";
</script>

<script src="../js/navigation.js" defer></script>
<script src="../js/search.js" defer></script>
<script src="../js/search_index.js" defer></script>
<script src="../js/searcher.js" defer></script>
<script src="../js/darkfish.js" defer></script>

<link href="../css/fonts.css" rel="stylesheet">
<link href="../css/rdoc.css" rel="stylesheet">


<body id="top" role="document" class="class">
<div id="navigation-toggle" role="button" tabindex="0" aria-label="Toggle sidebar" aria-expanded="true" aria-controls="navigation">
  <span aria-hidden="true">&#9776;</span>
</div>


<nav id="navigation" role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../table_of_contents.html#pages">Pages</a>
    <a href="../table_of_contents.html#classes">Classes</a>
    <a href="../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search (/) for a class, method, ..." spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  
  
  <div id="parent-class-section" class="nav-section">
  <h3>Ancestors</h3>
  <ul><li><a href="../Object.html">Object</a><ul><li><a href="../BasicObject.html">BasicObject</a></li></ul></li></ul>
</div>

  
  
  
  <div class="nav-section">
    <h3>Class Methods</h3>
    <ul class="link-list" role="directory">
      <li ><a href="#method-c-new">new</a></li>
    </ul>
  </div>



  <div class="nav-section">
    <h3>Instance Methods</h3>
    <ul class="link-list" role="directory">
      <li ><a href="#method-i-5B-5D">[]</a></li>
    </ul>
  </div>



  <footer id="validator-badges" role="contentinfo">
  <p><a href="https://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://ruby.github.io/rdoc/">RDoc</a> 6.10.0.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

</nav>

<main role="main" aria-labelledby="class-Prism::CodeUnitsCache">
  <h1 id="class-Prism::CodeUnitsCache" class="anchor-link class">
    class Prism::CodeUnitsCache
  </h1>

  <section class="description">
    
<p>A cache that can be used to quickly compute code unit offsets from byte offsets. It purposefully provides only a single <a href="CodeUnitsCache.html#method-i-5B-5D"><code>[]</code></a> method to access the cache in order to minimize surface area.</p>

<p>Note that there are some known issues here that may or may not be addressed in the future:</p>
<ul><li>
<p>The first is that there are issues when the cache computes values that are not on character boundaries. This can result in subsequent computations being off by one or more code units.</p>
</li><li>
<p>The second is that this cache is currently unbounded. In theory we could introduce some kind of LRU cache to limit the number of entries, but this has not yet been implemented.</p>
</li></ul>

  </section>

  <section id="5Buntitled-5D" class="documentation-section anchor-link">





     <section id="public-class-5Buntitled-5D-method-details" class="method-section anchor-link">
       <header>
         <h3>Public Class Methods</h3>
       </header>

      <div id="method-c-new" class="method-detail anchor-link ">
        <div class="method-header">
            <div class="method-heading">
              <a href="#method-c-new" title="Link to this method">
                <span class="method-name">new</span>
                <span class="method-args">(source, encoding)</span>
              </a>
            </div>
        </div>

          <div class="method-controls">
            <details class="method-source-toggle">
              <summary>Source</summary>
            </details>
          </div>

        <div class="method-description">
          <div class="method-source-code" id="new-source">
            <pre><span class="ruby-comment"># File lib/prism/parse_result.rb, line 198</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">initialize</span>(<span class="ruby-identifier">source</span>, <span class="ruby-identifier">encoding</span>)
  <span class="ruby-ivar">@source</span> = <span class="ruby-identifier">source</span>
  <span class="ruby-ivar">@counter</span> =
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">encoding</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Encoding</span><span class="ruby-operator">::</span><span class="ruby-constant">UTF_16LE</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">encoding</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Encoding</span><span class="ruby-operator">::</span><span class="ruby-constant">UTF_16BE</span>
      <span class="ruby-constant">UTF16Counter</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">source</span>, <span class="ruby-identifier">encoding</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-constant">LengthCounter</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">source</span>, <span class="ruby-identifier">encoding</span>)
    <span class="ruby-keyword">end</span>

  <span class="ruby-ivar">@cache</span> = {} <span class="ruby-comment">#: Hash[Integer, Integer]</span>
  <span class="ruby-ivar">@offsets</span> = [] <span class="ruby-comment">#: Array[Integer]</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          <p>Initialize a new cache with the given source and encoding.</p>
        </div>


      </div>

    </section>

     <section id="public-instance-5Buntitled-5D-method-details" class="method-section anchor-link">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

      <div id="method-i-5B-5D" class="method-detail anchor-link ">
        <div class="method-header">
            <div class="method-heading">
              <a href="#method-i-5B-5D" title="Link to this method">
                <span class="method-name">[]</span>
                <span class="method-args">(byte_offset)</span>
              </a>
            </div>
        </div>

          <div class="method-controls">
            <details class="method-source-toggle">
              <summary>Source</summary>
            </details>
          </div>

        <div class="method-description">
          <div class="method-source-code" id="5B-5D-source">
            <pre><span class="ruby-comment"># File lib/prism/parse_result.rb, line 212</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">[]</span>(<span class="ruby-identifier">byte_offset</span>)
  <span class="ruby-ivar">@cache</span>[<span class="ruby-identifier">byte_offset</span>] <span class="ruby-operator">||=</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">index</span> = <span class="ruby-ivar">@offsets</span>.<span class="ruby-identifier">bsearch_index</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">offset</span><span class="ruby-operator">|</span> <span class="ruby-identifier">offset</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">byte_offset</span> }).<span class="ruby-identifier">nil?</span>
      <span class="ruby-ivar">@offsets</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">byte_offset</span>
      <span class="ruby-ivar">@counter</span>.<span class="ruby-identifier">count</span>(<span class="ruby-value">0</span>, <span class="ruby-identifier">byte_offset</span>)
    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">index</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
      <span class="ruby-ivar">@offsets</span>.<span class="ruby-identifier">unshift</span>(<span class="ruby-identifier">byte_offset</span>)
      <span class="ruby-ivar">@counter</span>.<span class="ruby-identifier">count</span>(<span class="ruby-value">0</span>, <span class="ruby-identifier">byte_offset</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-ivar">@offsets</span>.<span class="ruby-identifier">insert</span>(<span class="ruby-identifier">index</span>, <span class="ruby-identifier">byte_offset</span>)
      <span class="ruby-identifier">offset</span> = <span class="ruby-ivar">@offsets</span>[<span class="ruby-identifier">index</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>]
      <span class="ruby-ivar">@cache</span>[<span class="ruby-identifier">offset</span>] <span class="ruby-operator">+</span> <span class="ruby-ivar">@counter</span>.<span class="ruby-identifier">count</span>(<span class="ruby-identifier">offset</span>, <span class="ruby-identifier">byte_offset</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">offset</span>)
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          <p>Retrieve the code units offset from the given byte offset.</p>
        </div>


      </div>

    </section>

  </section>
</main>

